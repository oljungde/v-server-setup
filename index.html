<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V-Server Setup</title>
    <link rel="icon" href="./img/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="./styles.css">
</head>

<body>

    <div class="container">
        <h1>V-Server setup</h1>

        <h2>Description assignment</h2>
        <p>This readme file describes how the project task ‘V-Server-Setup’ is solved as part of the DevSecOps course of
            the Developer Akademie.</p>

        <hr>

        <h2>First login to the server and setting up an SSH key</h2>

        <h3>Test login on the server</h3>
        <ul>
            <li>To test the login on the server, try to log on to the server via ssh with username and password. Open a
                command line such as <code>cmd</code> or <code>git-bash</code>. Use the following command to establish a
                connection to your server:
                <pre><code>ssh &lt;your_username&gt;@&lt;your_ip&gt;</code></pre>
                Replace <code>&lt;your_username&gt;</code> and <code>&lt;your_ip&gt;</code> with your actual login data,
                e.g.:
                <pre><code>ssh jdoe@555.555.555.555</code></pre>
            </li>
            <li>For the first time of login you will see a message, that you are unknown for the server. You have to
                "create" a fingerprint on the server:
                <img src="./img/fingerprint.png" alt="fingerprint">
            </li>
            <li>Type <code>yes</code> in the command shell.</li>
            <li>After this you have to authenticate with your password. Now you should see something like this in your
                command shell:
                <img src="./img/logged_in.png" alt="logged-in">
            </li>
            <li>Congratulations, you are logged in! Please open a new local terminal or logout from the server with:
                <pre><code>logout</code></pre>
            </li>
        </ul>

        <h3>Generate a ssh key and deposit it on the server</h3>

        <h4>ssh key generation</h4>
        <div class="warning">
            <strong>WARNING</strong><br>
            To generate a ssh key use a new command line on your <u><strong>local machine</strong></u>
        </div>
        <pre><code>ssh-keygen -t ed25519</code></pre>
        <p>The system will ask you under which file path the new ssh key should be saved. You can also secure the key
            with a password. If you want to do this, make sure that you keep this password safe. If you want to use a
            small password, simply confirm with the <code>Enter</code> key</p>
        <ul>
            <li>After creating your key, you will see the following in the shell.
                <img src="./img/create_ssh_key.png" alt="create_ssh_key">
            </li>
        </ul>

        <h4>Copy ssh key to VM-Server</h4>
        <ul>
            <li>To copy the generated ssh to your VM use the following command. Make sure you are on your local machine
                command line:
                <pre><code># ssh-copy-id -i &lt;path/to/your/key&gt; &lt;user&gt;@&lt;host&gt;

ssh-copy-id -i ~/.ssh/da_cloud_vm_ed25519.pub ojung@116.203.78.54</code></pre>
            </li>
            <li>You have to confirm this action by entering your password für the virtual machine again. After this you
                will the the following output in the terminal.
                <img src="./img/copy_ssh_vm.png" alt="copy_ssh_vm">
            </li>
            <li>Now, you can login to the cloud machine:
                <pre><code># ssh -i &lt;~/path/to/key&gt; &lt;user@host&gt;

ssh -i ~/.ssh/da_cloud_vm_ed25519 ojung@116.203.78.54</code></pre>
            </li>
        </ul>

        <hr>

        <h2>Deactivate password login</h2>
        <p>For security reasons, it is advisable to deactivate the password login on the VM. For example, a password can
            be cracked using a brute force attack.</p>
        <ul>
            <li>Make sure, you are logged in to the VM-Server. now editing the ssh config file. To edit this config file
                administration right on the VM are needed, so we need a <code>sudo</code> in front of the command:
                <pre><code>sudo nano /etc/ssh/sshd_config</code></pre>
            </li>
            <li>The nano editor is opened, now change this line:<br>
                <code>#PasswordAuthentication yes</code><br>
                to<br>
                <code>PasswordAuthentication no</code>
            </li>
            <li>To save the file use <code>CTRL+S</code> and close it with <code>CTRL+X</code></li>
            <li>Restart the ssh service with:<br>
                <code>sudo systemctl restart ssh.service</code>
            </li>
            <li>You can check if the ssh service is running with:<br>
                <code>sudo systemctl status ssh.service</code>
            </li>
            <li>The answer from the server should look like this:
                <img src="./img/restart_ssh.png" alt="restart_ssh">
            </li>
            <li>You can check if the login with a password is possible with the command:
                <pre><code># ssh -o PubkeyAuthentication=no &lt;user&gt;@&lt;host&gt;

ssh -o PubkeyAuthentication=no ojung@116.203.78.54</code></pre>
                You see something like this?
                <img src="./img/no_password_access.png" alt="no_password_access">
                Perfect, this is exactly what we want.
            </li>
        </ul>

        <hr>

        <h2>Webserver configuration with nginx</h2>
        <p>A web server delivers static or dynamic files, for example for a web application or a website. nginx is used
            for this server, another option would be Apache, for example.</p>

        <h3>Install nginx</h3>
        <ul>
            <li>To use the VM as a Webserver it is needed to install nginx. First it is recommended to update the
                installed packages on the VM. Use:
                <pre><code>sudo apt update</code></pre>
            </li>
            <li>Install nginx with:
                <pre><code>sudo apt install nginx -y</code></pre>
            </li>
            <li>You can then check whether nginx is now running:
                <pre><code>sudo systemctl status nginx.service</code></pre>
            </li>
            <li>You should see an output in your command line like this:
                <img src="./img/running_nginx.png" alt="running_nginx">
            </li>
            <li>Now it is possible to check if the web server is running as expectet. Open your browser and enter the IP
                address of your Server, e.g. <code>116.203.78.54</code>. You the a website like this?
                <img src="./img/webserver_running.png" alt="webserver_running">
            </li>
        </ul>

        <h3>Alternative nginx configuration</h3>
        <ul>
            <li>To see the code of the nginx start page, it is possible zo use the <code>cat</code> command on the VM:
                <pre><code>sudo cat /var/www/html/index.nginx-debian.html</code></pre>
            </li>
            <li>Now the HTML code of the page is displayed in the command line:
                <img src="./img/nginx-html.png" alt="nginx-html">
            </li>
            <li>Create a new folder for the alternative start page:
                <pre><code>sudo mkdir /var/www/html/web</code></pre>
            </li>
            <li>Create a new empty HTML file. This page wird the new start page for our nginx setup.
                <pre><code>sudo touch /var/www/html/web/alternate-index.html</code></pre>
            </li>
            <li>Edit the HTML code of this page with <code>nano</code>
                <pre><code>sudo nano /var/www/html/web/alternate-index.html</code></pre>
                After the edit the code could lock like this:
                <img src="./img/new_html.png" alt="new_html">
            </li>
            <li>Save the file with <code>CTRL+S</code> and leave the editor with <code>CTRL+X</code></li>
            <li>Add a new nginx configuration for the enabled sites
                <pre><code>sudo nano /etc/nginx/sites-enabled/web</code></pre>
                Enter the following to this file:
                <pre><code>server {
      listen 8081;
      listen [::]:8081;

      root /var/www/http/alternatives;
      index alternate-index.html;

      location / {
              try_files $uri $uri/ =404;
      }
}</code></pre>
            </li>
            <li>Restart the nginx service with:<br>
                <code>sudo service nginx restart</code>
            </li>
            <li>Check if the service is restarted an is running with:<br>
                <code>sudo systemctl status nginx.service</code>
            </li>
            <li>If it is desired that the old nginx start page is no longer accessible, it is possible to set up a port
                forwarding for the default nginx configuration.
                <ul>
                    <li>Open the default nginx configuration with:
                        <pre><code>sudo nano /etc/nginx/sites-enabled/default</code></pre>
                    </li>
                    <li>Lock for the <code>location</code> entry and add these lines:
                        <pre><code># Port forwarding to 8081
proxy_pass http://127.0.0.1:8081</code></pre>
                    </li>
                    <li>Your file should lock like this:
                        <pre><code># ... some comments and commented out settings above
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /var/www/html;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        server_name _;

        location / {
                # Port forwarding to 8081
                proxy_pass http://127.0.0.1:8081/;
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }

        # ... some more comments and commented out settings below
}</code></pre>
                    </li>
                </ul>
            </li>
        </ul>

        <hr>

        <h2>Git setup</h2>
        <ul>
            <li>Check if git is installed on the server with <code>git --version</code>. You should see something like
                this in your terminal:
                <img src="./img/git-version.png" alt="git-version">
            </li>
            <li>Create a new ssh key on the VM server:
                <pre><code>ssh-keygen -t ed25519</code></pre>
                Confirm the save path and file name or adjust it according to your wishes. You can also assign a
                password if you wish. This process has already been described above when the ssh key was created for the
                local machine.
            </li>
            <li>Open the public ssh key an copy it with <code>sudo cat ~/.ssh/&lt;your_file_name&gt;.pub</code>
                <div class="warning">
                    <strong>WARNING</strong><br>
                    For security reasons, always use the file with the <code>.pub</code> file extension
                </div>
            </li>
            <li>Store the ssh key in your github account under <code>Settings/SSH and GPG keys</code>
                <img src="./img/github-ssh.png" alt="github-ssh">
                Now it is possible to work with git on the VM-Server.
            </li>
        </ul>

        <hr>

        <h2>Publication of this documentation as a website [Additional configuration (optional)]</h2>
        <ul>
            <li>Create new folder <code>vm-setup</code> inside the <code>web</code> folder
                <pre><code>sudo mkdir /var/www/html/web/vm-setup</code></pre>
            </li>
            <li>Navigate to this folder with <code>cd /var/www/html/web/vm-setup</code></li>
            <li>Clone the repository into this folder:
                <pre><code>sudo git clone https://github.com/oljungde/v-server-setup.git .</code></pre>
            </li>
            <li>Edit the nginx configuration for web
                <pre><code>sudo nano /etc/nginx/sites-enabled/web</code></pre>
                <ul>
                    <li>Change the file content to:
                        <pre><code>server {
  listen 80;
  listen [::]:80;

  server_name _;

  location / {
      proxy_pass http://127.0.0.1:8081;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
  }
}

server {
  listen 8081;
  listen [::]:8081;

  root /var/www/html/web;
  index alternate-index.html index.html;

  location / {
      try_files $uri $uri/ =404;
  }
}</code></pre>
                    </li>
                    <li>The first server block serves as a reverse proxy and ensures that all requests arriving at port
                        80 are forwarded to port 8081.</li>
                    <li>The second server block is the actual web server configuration, which can be accessed via the
                        proxy.</li>
                </ul>
            </li>
            <li>Delete the default nginx configuration, otherwise our site would still not be accessible
                <pre><code>sudo rm /etc/nginx/sites-enabled/default</code></pre>
            </li>
            <li>Restart the nginx service with <code>sudo systemctl restart nginx.service</code></li>
            <li>The modified "nginx homepage" is now available at <code>http://116.203.78.54</code> and this
                documentation is available as a website at <code>http://116.203.78.54/vm-setup</code></li>
        </ul>

    </div>

</body>

</html>
